{% set periods = guest.system_periods %}
{% set pricing = product.pricing %}
{% set transfer_tlds = guest.serviceDomain_tlds({ "allow_transfer": 1 })%}
<style>
@media (max-width: 768px) {
    .table-responsive {
        overflow-x: hidden; /* Prevent unnecessary horizontal scrolling */
    }

    /* Ensure that table layout switches to block only on mobile */
    .table-responsive table, 
    .table-responsive thead, 
    .table-responsive tbody, 
    .table-responsive th, 
    .table-responsive td, 
    .table-responsive tr {
        display: block;
        width: 100%;
    }

    .table-responsive thead {
        display: none; /* Hide the original table headers on mobile */
    }

    .table-responsive tbody tr {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        width: 100%; /* Ensure rows take full width */
    }

    .table-responsive tbody td {
        display: block;
        position: relative;
        padding-left: 40%; /* Adjust space for labels */
        padding-top: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
        width: 100%; /* Ensure cells take full width */
        box-sizing: border-box;
        text-align: right;
    }

    .table-responsive tbody td::before {
        content: attr(data-label); /* Display header label */
        position: absolute;
        left: 10px;
        top: 10px;
        font-weight: bold;
        color: #495057;
        white-space: nowrap;
        text-align: left;
        width: 30%;
        box-sizing: border-box;
    }

    .table-responsive tbody td:last-child {
        border-bottom: none; /* Remove bottom border from the last cell */
    }
}
</style>

<div class="card">
    <div class="card-body" id="register">
    {% if guest.extension_is_on({"mod":"domainsbot"}) %}
        <div class="text-center mt-3">
            <p class="text-muted d-inline">{{ 'Need ideas? Explore:'|trans }}</p>
            <a href="/domainsbot" class="btn btn-sm btn-outline-primary ms-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12h1m8 -9v1m8 8h1m-15.4 -6.4l.7 .7m12.1 -.7l-.7 .7" /><path d="M9 16a5 5 0 1 1 6 0a3.5 3.5 0 0 0 -1 3a2 2 0 0 1 -4 0a3.5 3.5 0 0 0 -1 -3" /><path d="M9.7 17l4.6 0" /></svg> {{ 'Domain Suggestions'|trans }}
            </a>
        </div>
    {% endif %}
        <form id="domain-search-transfer-form">
            <div class="row g-2 mb-3 {% if guest.extension_is_on({"mod":"domainsbot"}) %}mt-6{% endif %}">
                <div class="col-12 col-md-8">
                    <input type="text" class="form-control form-control-lg" placeholder="Enter your domain name" aria-label="Domain Name" name="domain_name" value="{{ request.domain_name }}" autocapitalize="none" required>
                </div>
                <div class="col-12 col-md-4 d-flex gap-2">
                    <button class="btn btn-primary btn-lg w-100 w-md-auto flex-fill flex-md-grow-0" type="button" id="domain-check">{{ 'Search'|trans }}</button>
                    {% if transfer_tlds is not empty %}
                        <button class="btn btn-success btn-lg w-100 w-md-auto flex-fill flex-md-grow-0" type="button" id="transfer-check">{{ 'Transfer'|trans }}</button>
                    {% endif %}
                    <select class="form-select form-select-lg w-100 mt-2 mt-md-0 ms-md-2 onAfterDomainCheck" name="register_years" id="registration-years" style="display:none;"></select>
                    <input type="text" class="form-control mt-2 mt-md-0 ms-md-2" name="transfer_code" value="{{ request.transfer_code }}" placeholder="{{ 'Enter domain transfer code'|trans }}" id="domain-transfer-config" style="display:none;" />
                    <span id="transfer-price" class="text-center align-self-center mt-2 mt-md-0 ms-md-2 text-nowrap fw-bold" style="display:none; margin-top: 8px;"></span>
                </div>
            </div>
            <p class="text-muted text-center mt-4" id="info-text">Search for your perfect domain name{% if transfer_tlds is not empty %} or transfer an existing one{% endif %}.</p>
            <input type="hidden" name="id" value="{{ product.id }}" />
            <input type="hidden" name="register_tld" value="" />
            <input type="hidden" name="register_sld" value="" />
            <input type="hidden" name="transfer_tld" value="" />
            <input type="hidden" name="transfer_sld" value="" />
            <input type="hidden" name="action" value="" />
            <div class="mb-3 onAfterDomainCheck2" style="display:none;">
                <label class="form-check">
                <input class="form-check-input" type="checkbox" onclick="$('#nameservers').slideToggle();">
                <span class="form-check-label">{{ 'I want to use my nameservers'|trans }}</span>
                </label>
            </div>
            <div class="mb-3" id="nameservers" style="display:none; margin: 10px 0;">
                <div class="mb-3">
                    <input type="text" class="form-control" name="ns1" value="" placeholder="{{ 'Nameserver 1'|trans }}"/>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" name="ns2" value="" placeholder="{{ 'Nameserver 2'|trans }}"/>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" name="ns3" value="" placeholder="{{ 'Nameserver 3'|trans }}"/>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" name="ns4" value="" placeholder="{{ 'Nameserver 4'|trans }}"/>
                </div>
            </div>
            <div class="mb-3" id="config-next-domain">
                <button type="submit" class="btn btn-primary btn-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M7 7l5 5l-5 5"></path>
                        <path d="M13 7l5 5l-5 5"></path>
                    </svg>
                    {{ 'Next'|trans }}
                </button>
            </div>
            <div class="mb-3" id="config-next-domain2">
                <button type="submit" class="btn btn-primary btn-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M7 7l5 5l-5 5"></path>
                        <path d="M13 7l5 5l-5 5"></path>
                    </svg>
                    {{ 'Next'|trans }}
                </button>
            </div>
        </form>
    </div>
</div>
{% set currency = guest.cart_get_currency %}
<div class="card mt-3">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>{{ 'Domain'|trans }}</th>
                        <th>{{ 'Registration'|trans }}</th>
                        <th>{{ 'Renewal'|trans }}</th>
                        <th>{{ 'Transfer'|trans }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tld, details in pricing %}
                        {% if details.active == 1 %}
                            <tr>
                                <td data-label="{{ 'Domain'|trans }}">{{ tld }}</td>
                                <td data-label="{{ 'Registration'|trans }}">
                                    {% if details.allow_register == 1 %}
                                        {{ currency.format|replace({'{{price}}': (details.price_registration * currency.conversion_rate)|number_format(2, '.', ',') }) }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td data-label="{{ 'Renewal'|trans }}">
                                    {{ currency.format|replace({'{{price}}': (details.price_renew * currency.conversion_rate)|number_format(2, '.', ',') }) }}
                                </td>
                                <td data-label="{{ 'Transfer'|trans }}">
                                    {% if details.allow_transfer == 1 %}
                                        {{ currency.format|replace({'{{price}}': (details.price_transfer * currency.conversion_rate)|number_format(2, '.', ',') }) }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="text/javascript">
function show(el, display = '') {
    if (!el) return;
    el.style.display = display;
}

function hide(el) {
    if (!el) return;
    el.style.display = 'none';
}

function fadeIn(el, display = 'block', durationMs = 150) {
    if (!el) return;

    if (getComputedStyle(el).display !== 'none') {
        el.style.display = display;
        el.style.opacity = '1';
        return;
    }

    el.style.opacity = '0';
    el.style.display = display;
    el.style.transition = `opacity ${durationMs}ms ease`;

    requestAnimationFrame(() => {
        el.style.opacity = '1';
    });
}

document.addEventListener("DOMContentLoaded", () => {
    hide(document.getElementById('config-next-domain'));
    hide(document.getElementById('config-next-domain2'));

    document.querySelectorAll('.onAfterDomainCheck, .onAfterDomainCheck2').forEach(hide);
    hide(document.getElementById('domain-transfer-config'));
    hide(document.getElementById('transfer-price'));

    document.querySelectorAll('#register .order-button').forEach(hide);

    const storedDomain = localStorage.getItem("selected_domain");
    if (storedDomain) {
        const searchInput = document.querySelector("input[name='domain_name']");
        if (searchInput) {
            searchInput.value = storedDomain;
            localStorage.removeItem("selected_domain");
        }
    }

    ['config-next', 'config-next-domain', 'config-next-domain2'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    if (document.querySelector('.addons')) {
        document.querySelectorAll('.order-button').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                this.style.display = 'none';

                const addons = document.querySelector('.addons');
                if (addons) {
                    addons.style.display = 'block';
                    addons.style.maxHeight = addons.scrollHeight + 'px';
                    addons.style.transition = 'max-height 0.2s ease';
                }
            }, { once: true });
        });
    }

    document.querySelectorAll('.addon-period-selector').forEach(select => {
        const update = () => {
            const r = select.getAttribute('rel');
            if (!r) return;

            const container = document.getElementById(r);
            if (!container) return;

            container.querySelectorAll('span').forEach(span => span.style.display = 'none');

            const active = container.querySelector('span.' + select.value);
            if (active) {
                active.style.display = 'inline';
                active.style.opacity = 0;
                active.style.transition = 'opacity 0.2s ease';
                requestAnimationFrame(() => { active.style.opacity = 1; });
            }
        };

        select.addEventListener('change', update);
        update();
    });

    const nsToggle = document.querySelector('.onAfterDomainCheck2 input.form-check-input');
    const nsBox = document.getElementById('nameservers');
    if (nsToggle && nsBox) {
        nsToggle.addEventListener('change', () => {
            nsBox.style.display = nsToggle.checked ? 'block' : 'none';
        });
    }

    const transferCheck = document.getElementById('transfer-check');
    if (transferCheck) {
        transferCheck.addEventListener('click', function (e) {
            e.preventDefault();

            const domainInput = document.querySelector('input[name="domain_name"]');
            if (!domainInput) return;

            const domain = domainInput.value.trim();
            if (!domain) {
                FOSSBilling.message("{{ 'Please enter a domain name'|trans }}");
                return;
            }

            const parts = domain.split('.');
            let sld = '';
            let tld = '';

            if (parts.length >= 3) {
                sld = parts.slice(0, -2).join('.');
                tld = '.' + parts.slice(-2).join('.');
            } else if (parts.length === 2) {
                sld = parts[0];
                tld = '.' + parts[1];
            }

            const sldInput = document.querySelector('input[name="transfer_sld"]');
            const tldInput = document.querySelector('input[name="transfer_tld"]');
            const actionInput = document.querySelector('input[name="action"]');

            if (sldInput) sldInput.value = sld;
            if (tldInput) tldInput.value = tld;
            if (actionInput) actionInput.value = 'transfer';

            API.guest.post(
                'servicedomain/can_be_transferred',
                { sld: sld, tld: tld },
                function (result) {
                    setTransferPricing(tld);

                    const domainNameEl = document.getElementById('domain-name');
                    if (domainNameEl) domainNameEl.textContent = domain;

                    domainInput.readOnly = true;

                    const transferPrice = document.getElementById('transfer-price');
                    if (transferPrice) fadeIn(transferPrice);

                    const transferConfig = document.getElementById('domain-transfer-config');
                    if (transferConfig) {
                        fadeIn(transferConfig);
                        transferConfig.setAttribute('required', 'true');
                    }

                    const infoText = document.getElementById('info-text');
                    if (infoText) infoText.style.display = 'none';

                    const domainCheckBtn = document.getElementById('domain-check');
                    if (domainCheckBtn) domainCheckBtn.style.display = 'none';

                    transferCheck.style.display = 'none';

                    const orderBtn = document.querySelector('#register .order-button');
                    if (orderBtn) orderBtn.style.display = '';
                }
            );
        });
    }

    const domainCheck = document.getElementById('domain-check');
    if (domainCheck) {
        domainCheck.addEventListener('click', function (e) {
            e.preventDefault();

            const domainInput = document.querySelector('input[name="domain_name"]');
            if (!domainInput) return;

            const domain = domainInput.value.trim();
            if (!domain) {
                FOSSBilling.message("{{ 'Please enter a domain name'|trans }}");
                return;
            }

            const parts = domain.split('.');
            let sld = '';
            let tld = '';

            if (parts.length >= 3) {
                sld = parts.slice(0, -2).join('.');
                tld = '.' + parts.slice(-2).join('.');
            } else if (parts.length === 2) {
                sld = parts[0];
                tld = '.' + parts[1];
            }

            const sldInput = document.querySelector('input[name="register_sld"]');
            const tldInput = document.querySelector('input[name="register_tld"]');
            const actionInput = document.querySelector('input[name="action"]');

            if (sldInput) sldInput.value = sld;
            if (tldInput) tldInput.value = tld;
            if (actionInput) actionInput.value = 'register';

            API.guest.post(
                'servicedomain/check',
                { sld: sld, tld: tld },
                function (result) {
                    setPricing(tld);

                    const domainNameEl = document.getElementById('domain-name');
                    if (domainNameEl) domainNameEl.textContent = domain;

                    domainInput.readOnly = true;

                    document.querySelectorAll('.onAfterDomainCheck').forEach(el => fadeIn(el));
                    document.querySelectorAll('.onAfterDomainCheck2').forEach(el => fadeIn(el));

                    const transferBtn = document.getElementById('transfer-check');
                    const infoText = document.getElementById('info-text');
                    const orderBtn = document.querySelector('#register .order-button');

                    domainCheck.style.display = 'none';
                    if (transferBtn) transferBtn.style.display = 'none';
                    if (infoText) infoText.style.display = 'none';
                    if (orderBtn) orderBtn.style.display = '';
                }
            );
        });
    }

    function setPricing(tld) {
        API.guest.post(
            'servicedomain/pricing',
            { tld: tld },
            function (result) {
                const yearsSelect = document.getElementById('registration-years');
                if (!yearsSelect) return;

                yearsSelect.innerHTML = '';

                const regPrice = Number(result.price_registration);
                let renewPrice = Number(result.price_renew);

                if (!Number.isFinite(renewPrice)) {
                    renewPrice = regPrice;
                }

                for (let years = 1; years <= 5; years++) {
                    const totalPrice =
                        years === 1 ? regPrice : regPrice + (years - 1) * renewPrice;

                    const formattedPrice = bb.currency(
                        totalPrice,
                        {{ currency.conversion_rate }},
                        "{{ currency.code }}",
                        1
                    );

                    yearsSelect.appendChild(
                        new Option(
                            `${years}{{ ' Year/s @ '|trans }}${formattedPrice}`,
                            String(years)
                        )
                    );
                }

                fadeIn(yearsSelect, '');
                show(document.getElementById('config-next-domain'));
            }
        );
    }

    function setTransferPricing(tld) {
        API.guest.post(
            'servicedomain/pricing',
            { tld: tld },
            function (result) {

                const price = bb.currency(
                    result.price_transfer,
                    {{ currency.conversion_rate }},
                    "{{ currency.code }}"
                );

                const transferPriceEl = document.getElementById('transfer-price');
                if (transferPriceEl) {
                    transferPriceEl.textContent = price;
                    fadeIn(transferPriceEl, '');
                }

                const nextBtnWrap = document.getElementById('config-next-domain2');
                if (nextBtnWrap) {
                    nextBtnWrap.style.display = '';
                }

                const nextBtn = nextBtnWrap ? nextBtnWrap.querySelector('button[type="submit"]') : null;
                if (nextBtn) {
                    nextBtn.disabled = false;
                }
            }
        );
    }
});
</script>