{% set periods = guest.system_periods %}
{% set pricing = product.pricing %}
{% set transfer_tlds = guest.serviceDomain_tlds({ "allow_transfer": 1 })%}
<style>
@media (max-width: 768px) {
    .table-responsive {
        overflow-x: hidden;
    }

    .table-responsive table, 
    .table-responsive thead, 
    .table-responsive tbody, 
    .table-responsive th, 
    .table-responsive td, 
    .table-responsive tr {
        display: block;
        width: 100%;
    }

    .table-responsive thead {
        display: none;
    }

    .table-responsive tbody tr {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        width: 100%;
    }

    .table-responsive tbody td {
        display: block;
        position: relative;
        padding-left: 40%;
        padding-top: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
        width: 100%;
        box-sizing: border-box;
        text-align: right;
    }

    .table-responsive tbody td::before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        top: 10px;
        font-weight: bold;
        color: #495057;
        white-space: nowrap;
        text-align: left;
        width: 30%;
        box-sizing: border-box;
    }

    .table-responsive tbody td:last-child {
        border-bottom: none;
    }
}
</style>

<div class="card">
    <div class="card-body" id="register">
    {% if guest.extension_is_on({"mod":"domainsbot"}) %}
        <div class="text-center mt-3">
            <p class="text-muted d-inline">{{ 'Need ideas? Explore:'|trans }}</p>
            <a href="/domainsbot" class="btn btn-sm btn-outline-primary ms-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12h1m8 -9v1m8 8h1m-15.4 -6.4l.7 .7m12.1 -.7l-.7 .7" /><path d="M9 16a5 5 0 1 1 6 0a3.5 3.5 0 0 0 -1 3a2 2 0 0 1 -4 0a3.5 3.5 0 0 0 -1 -3" /><path d="M9.7 17l4.6 0" /></svg> {{ 'Domain Suggestions'|trans }}
            </a>
        </div>
    {% endif %}
        <div id="domain-search-transfer-form">
            <div class="row g-2 mb-3 {% if guest.extension_is_on({"mod":"domainsbot"}) %}mt-6{% endif %}">
                <div class="col-12 col-md-8">
                    <input type="text" class="form-control form-control-lg" placeholder="Enter your domain name" aria-label="Domain Name" name="domain_name" value="{{ request.domain_name }}" autocapitalize="none" required>
                </div>
                <div class="col-12 col-md-4 d-flex gap-2">
                    <button class="btn btn-primary btn-lg w-100 w-md-auto flex-fill flex-md-grow-0" type="button" id="domain-check">{{ 'Search'|trans }}</button>
                    {% if transfer_tlds is not empty %}
                        <button class="btn btn-success btn-lg w-100 w-md-auto flex-fill flex-md-grow-0" type="button" id="transfer-check">{{ 'Transfer'|trans }}</button>
                    {% endif %}
                    <select class="form-select form-select-lg w-100 mt-2 mt-md-0 ms-md-2 onAfterDomainCheck" name="register_years" id="registration-years" style="display:none;"></select>
                    <input type="text" class="form-control mt-2 mt-md-0 ms-md-2" name="transfer_code" value="{{ request.transfer_code }}" placeholder="{{ 'Enter domain transfer code'|trans }}" id="domain-transfer-config" style="display:none;" />
                    <span id="transfer-price" class="text-center align-self-center mt-2 mt-md-0 ms-md-2 text-nowrap fw-bold" style="display:none; margin-top: 8px;"></span>
                </div>
            </div>
            <p class="text-muted text-center mt-4" id="info-text">Search for your perfect domain name{% if transfer_tlds is not empty %} or transfer an existing one{% endif %}.</p>
            <input type="hidden" name="id" value="{{ product.id }}" />
            <input type="hidden" name="register_tld" value="" />
            <input type="hidden" name="register_sld" value="" />
            <input type="hidden" name="transfer_tld" value="" />
            <input type="hidden" name="transfer_sld" value="" />
            <input type="hidden" name="action" value="" />

            <div class="onAfterDomainCheck2" style="display:none;">
              <div class="row g-3 mt-3 mb-3">
                <!-- Contacts -->
                <div class="col-12 col-lg-6">
                  <div class="card">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="card-title mb-0">{{ 'Contacts'|trans }}</h3>

                        {% if profile is defined and profile and (profile.id ?? 0) %}
                        <a href="{{ 'client/profile'|link }}" target="_blank" class="btn btn-sm btn-outline-primary">
                          {{ 'Update profile'|trans }}
                        </a>{% endif %}
                      </div>

                    {% if profile is defined and profile and (profile.id ?? 0) %}
                      <div class="text-muted mb-3">
                        {{ 'Please make sure your details are correct, otherwise your registration might fail.'|trans }}
                      </div>
                    {% else %}
                      <div class="text-muted mb-3">
                        {{ 'The domain will be registered using the information from your client profile. Please make sure your details are correct, otherwise your registration might fail.'|trans }}
                      </div>
                    {% endif %}

                      {% if profile is defined and profile and (profile.id ?? 0) %}
                        <hr class="my-3">

                        <div class="d-flex flex-column gap-2">
                          <div class="fw-semibold mb-1">
                            {{ ((profile.first_name ?? '') ~ ' ' ~ (profile.last_name ?? ''))|trim ?: '---' }}

                            {% set doc = (profile.document_nr ?? '')|trim %}
                            {% if doc %}
                              <span class="text-muted small fw-normal">
                                ({{ 'ID'|trans }}: {{ doc }})
                              </span>
                            {% endif %}
                          </div>

                          <div>
                            {{ (profile.company ?? '')|trim ?: '---' }}

                            {% set companyNr = (profile.company_number ?? '')|trim %}
                            {% if companyNr %}
                              <span class="text-muted small">
                                ({{ 'No.'|trans }} {{ companyNr }})
                              </span>
                            {% endif %}
                          </div>

                          <div class="d-flex flex-wrap gap-3">
                            <div>
                              <div class="text-muted small">{{ 'Email'|trans }}</div>
                              <div class="text-body">
                                {{ (profile.email ?? '')|trim ?: '---' }}
                              </div>
                            </div>

                            <div>
                              <div class="text-muted small">{{ 'Phone'|trans }}</div>
                              <div class="text-body">
                                {% set phone = (profile.phone ?? '')|trim %}
                                {% set cc = (profile.phone_cc ?? '')|trim %}
                                {{ (phone ? ('+' ~ (cc ?: '') ~ ' ' ~ phone)|trim : '---') }}
                              </div>
                            </div>
                          </div>

                          <div>
                            <div class="text-muted small">{{ 'Address'|trans }}</div>
                            <div class="small text-body">
                              {% set a1 = (profile.address_1 ?? '')|trim %}
                              {% set a2 = (profile.address_2 ?? '')|trim %}
                              {% set city = (profile.city ?? '')|trim %}
                              {% set state = (profile.state ?? '')|trim %}
                              {% set pc = (profile.postcode ?? '')|trim %}
                              {% set country = (profile.country ?? '')|trim %}

                              <div>{{ a1 ?: '---' }}</div>
                              {% if a2 %}<div>{{ a2 }}</div>{% endif %}
                              <div>
                                {{ [pc, city]|filter(v => v is not empty)|join(' ') ?: '---' }}
                                {% if state %}, {{ state }}{% endif %}
                              </div>
                              {% if country %}<div>{{ country }}</div>{% endif %}
                            </div>
                          </div>
                        </div>
                      {% endif %}

                    </div>
                  </div>
                </div>

                <!-- Nameservers -->
                <div class="col-12 col-lg-6">
                  <div class="card">
                    <div class="card-body">
                      <h3 class="card-title mb-3">{{ 'Nameservers'|trans }}</h3>

                      <select class="form-select" id="ns-mode" name="ns_mode">
                        <option value="default" selected>{{ 'Default nameservers'|trans }}</option>
                        <option value="custom">{{ 'Custom nameservers'|trans }}</option>
                      </select>

                      <div id="ns-default-hint" class="text-muted mt-3">
                        We'll use our default nameservers for this domain. You can change them later from your client area.
                      </div>

                      <div id="ns-custom-fields" class="mt-3 d-none">
                        <div class="mb-3">
                          <input type="text" class="form-control" name="ns1" placeholder="Nameserver 1" autocapitalize="off" disabled>
                        </div>
                        <div class="mb-3">
                          <input type="text" class="form-control" name="ns2" placeholder="Nameserver 2" autocapitalize="off" disabled>
                        </div>
                        <div class="mb-3">
                          <input type="text" class="form-control" name="ns3" placeholder="Nameserver 3" autocapitalize="off" disabled>
                        </div>
                        <div class="mb-0">
                          <input type="text" class="form-control" name="ns4" placeholder="Nameserver 4" autocapitalize="off" disabled>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-3" id="config-next-domain">
                <button type="submit" class="btn btn-primary btn-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M7 7l5 5l-5 5"></path>
                        <path d="M13 7l5 5l-5 5"></path>
                    </svg>
                    {{ 'Next'|trans }}
                </button>
            </div>
            <div class="mb-3" id="config-next-domain2">
                <button type="submit" class="btn btn-primary btn-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M7 7l5 5l-5 5"></path>
                        <path d="M13 7l5 5l-5 5"></path>
                    </svg>
                    {{ 'Next'|trans }}
                </button>
            </div>
        </div>
    </div>
</div>
{% set currency = guest.cart_get_currency %}
{% set sorted_tlds = pricing|keys|sort((a, b) => a <=> b) %}
<div class="card mt-3">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>{{ 'Domain'|trans }}</th>
                        <th>{{ 'Registration'|trans }}</th>
                        <th>{{ 'Renewal'|trans }}</th>
                        <th>{{ 'Transfer'|trans }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tld in sorted_tlds %}
                        {% set details = pricing[tld] %}
                        {% if details.active == 1 %}
                            <tr>
                                <td data-label="{{ 'Domain'|trans }}">{{ tld }}</td>
                                <td data-label="{{ 'Registration'|trans }}">
                                    {% if details.allow_register == 1 %}
                                        {{ currency.format|replace({'{{price}}': (details.price_registration * currency.conversion_rate)|number_format(2, '.', ',') }) }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td data-label="{{ 'Renewal'|trans }}">
                                    {{ currency.format|replace({'{{price}}': (details.price_renew * currency.conversion_rate)|number_format(2, '.', ',') }) }}
                                </td>
                                <td data-label="{{ 'Transfer'|trans }}">
                                    {% if details.allow_transfer == 1 %}
                                        {{ currency.format|replace({'{{price}}': (details.price_transfer * currency.conversion_rate)|number_format(2, '.', ',') }) }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const mode = document.getElementById('ns-mode');
    const hint = document.getElementById('ns-default-hint');
    const fields = document.getElementById('ns-custom-fields');
    const inputs = fields.querySelectorAll('input[name^="ns"]');

    const setNsMode = (value) => {
      const isCustom = value === 'custom';

      hint.classList.toggle('d-none', isCustom);
      fields.classList.toggle('d-none', !isCustom);

      inputs.forEach((input) => {
        input.disabled = !isCustom;
        if (!isCustom) input.value = '';
      });
    };

    mode.addEventListener('change', (e) => setNsMode(e.target.value));
    setNsMode(mode.value);

    const domain = sessionStorage.getItem("namingo_domain");

    if (!domain) return;

    const input = document.querySelector('input[name="domain_name"]');

    if (input) {
        input.value = domain;

        input.dispatchEvent(new Event("input", { bubbles: true }));
        input.dispatchEvent(new Event("change", { bubbles: true }));

        sessionStorage.removeItem("namingo_domain");
    }

});

function show(el, display = '') {
    if (!el) return;
    el.style.display = display;
}

function hide(el) {
    if (!el) return;
    el.style.display = 'none';
}

function fadeIn(el, display = 'block', durationMs = 150) {
    if (!el) return;

    if (getComputedStyle(el).display !== 'none') {
        el.style.display = display;
        el.style.opacity = '1';
        return;
    }

    el.style.opacity = '0';
    el.style.display = display;
    el.style.transition = `opacity ${durationMs}ms ease`;

    requestAnimationFrame(() => {
        el.style.opacity = '1';
    });
}

document.addEventListener("DOMContentLoaded", () => {
    hide(document.getElementById('config-next-domain'));
    hide(document.getElementById('config-next-domain2'));

    document.querySelectorAll('.onAfterDomainCheck, .onAfterDomainCheck2').forEach(hide);
    hide(document.getElementById('domain-transfer-config'));
    hide(document.getElementById('transfer-price'));

    document.querySelectorAll('#register .order-button').forEach(hide);

    const storedDomain = localStorage.getItem("selected_domain");
    if (storedDomain) {
        const searchInput = document.querySelector("input[name='domain_name']");
        if (searchInput) {
            searchInput.value = storedDomain;
            localStorage.removeItem("selected_domain");
        }
    }

    ['config-next', 'config-next-domain', 'config-next-domain2'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    if (document.querySelector('.addons')) {
        document.querySelectorAll('.order-button').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                this.style.display = 'none';

                const addons = document.querySelector('.addons');
                if (addons) {
                    addons.style.display = 'block';
                    addons.style.maxHeight = addons.scrollHeight + 'px';
                    addons.style.transition = 'max-height 0.2s ease';
                }
            }, { once: true });
        });
    }

    document.querySelectorAll('.addon-period-selector').forEach(select => {
        const update = () => {
            const r = select.getAttribute('rel');
            if (!r) return;

            const container = document.getElementById(r);
            if (!container) return;

            container.querySelectorAll('span').forEach(span => span.style.display = 'none');

            const active = container.querySelector('span.' + select.value);
            if (active) {
                active.style.display = 'inline';
                active.style.opacity = 0;
                active.style.transition = 'opacity 0.2s ease';
                requestAnimationFrame(() => { active.style.opacity = 1; });
            }
        };

        select.addEventListener('change', update);
        update();
    });

    const transferCheck = document.getElementById('transfer-check');
    if (transferCheck) {
        transferCheck.addEventListener('click', function (e) {
            e.preventDefault();

            const domainInput = document.querySelector('input[name="domain_name"]');
            if (!domainInput) return;

            const domain = domainInput.value.trim();
            if (!domain) {
                FOSSBilling.message("{{ 'Please enter a domain name'|trans }}");
                return;
            }

            const parts = domain.split('.');
            let sld = '';
            let tld = '';

            if (parts.length >= 3) {
                sld = parts.slice(0, -2).join('.');
                tld = '.' + parts.slice(-2).join('.');
            } else if (parts.length === 2) {
                sld = parts[0];
                tld = '.' + parts[1];
            }

            const sldInput = document.querySelector('input[name="transfer_sld"]');
            const tldInput = document.querySelector('input[name="transfer_tld"]');
            const actionInput = document.querySelector('input[name="action"]');

            if (sldInput) sldInput.value = sld;
            if (tldInput) tldInput.value = tld;
            if (actionInput) actionInput.value = 'transfer';

            API.guest.post(
                'servicedomain/can_be_transferred',
                { sld: sld, tld: tld },
                function (result) {
                    setTransferPricing(tld);

                    const domainNameEl = document.getElementById('domain-name');
                    if (domainNameEl) domainNameEl.textContent = domain;

                    domainInput.readOnly = true;

                    const transferPrice = document.getElementById('transfer-price');
                    if (transferPrice) fadeIn(transferPrice);

                    const transferConfig = document.getElementById('domain-transfer-config');
                    if (transferConfig) {
                        fadeIn(transferConfig);
                        transferConfig.setAttribute('required', 'true');
                    }

                    const infoText = document.getElementById('info-text');
                    if (infoText) infoText.style.display = 'none';

                    const domainCheckBtn = document.getElementById('domain-check');
                    if (domainCheckBtn) domainCheckBtn.style.display = 'none';

                    transferCheck.style.display = 'none';

                    const orderBtn = document.querySelector('#register .order-button');
                    if (orderBtn) orderBtn.style.display = '';
                },
                function (err) {
                    FOSSBilling.message(err?.message || "Transfer check failed");
                }
            );
        });
    }

    const domainCheck = document.getElementById('domain-check');
    if (domainCheck) {
        domainCheck.addEventListener('click', function (e) {
            e.preventDefault();

            const domainInput = document.querySelector('input[name="domain_name"]');
            if (!domainInput) return;

            const domain = domainInput.value.trim();
            if (!domain) {
                FOSSBilling.message("{{ 'Please enter a domain name'|trans }}");
                return;
            }

            const parts = domain.split('.');
            let sld = '';
            let tld = '';

            if (parts.length >= 3) {
                sld = parts.slice(0, -2).join('.');
                tld = '.' + parts.slice(-2).join('.');
            } else if (parts.length === 2) {
                sld = parts[0];
                tld = '.' + parts[1];
            }

            const sldInput = document.querySelector('input[name="register_sld"]');
            const tldInput = document.querySelector('input[name="register_tld"]');
            const actionInput = document.querySelector('input[name="action"]');

            if (sldInput) sldInput.value = sld;
            if (tldInput) tldInput.value = tld;
            if (actionInput) actionInput.value = 'register';

            API.guest.post(
                'servicedomain/check',
                { sld: sld, tld: tld },
                function (result) {
                    setPricing(tld);

                    const domainNameEl = document.getElementById('domain-name');
                    if (domainNameEl) domainNameEl.textContent = domain;

                    domainInput.readOnly = true;

                    document.querySelectorAll('.onAfterDomainCheck').forEach(el => fadeIn(el));
                    document.querySelectorAll('.onAfterDomainCheck2').forEach(el => fadeIn(el));

                    const transferBtn = document.getElementById('transfer-check');
                    const infoText = document.getElementById('info-text');
                    const orderBtn = document.querySelector('#register .order-button');

                    domainCheck.style.display = 'none';
                    if (transferBtn) transferBtn.style.display = 'none';
                    if (infoText) infoText.style.display = 'none';
                    if (orderBtn) orderBtn.style.display = '';
                },
                function (err) {
                    const msg =
                      err?.message ||
                      err?.error?.message ||
                      err?.error ||
                      err?.result?.message ||
                      "Domain check failed";

                    const code =
                      err?.code || err?.error?.code || err?.result?.code;

                    FOSSBilling.message(code ? `${msg} (Code: ${code})` : msg);

                    domainInput.readOnly = false;
                }
            );
        });
    }

    function setPricing(tld) {
        API.guest.post(
            'servicedomain/pricing',
            { tld: tld },
            function (result) {
                const yearsSelect = document.getElementById('registration-years');
                if (!yearsSelect) return;

                yearsSelect.innerHTML = '';

                const regPrice = Number(result.price_registration);
                let renewPrice = Number(result.price_renew);

                if (!Number.isFinite(renewPrice)) {
                    renewPrice = regPrice;
                }

                for (let years = 1; years <= 5; years++) {
                    const totalPrice =
                        years === 1 ? regPrice : regPrice + (years - 1) * renewPrice;

                    const formattedPrice = bb.currency(
                        totalPrice,
                        {{ currency.conversion_rate }},
                        "{{ currency.code }}",
                        1
                    );

                    yearsSelect.appendChild(
                        new Option(
                            `${years}{{ ' Year/s @ '|trans }}${formattedPrice}`,
                            String(years)
                        )
                    );
                }

                fadeIn(yearsSelect, '');
                show(document.getElementById('config-next-domain'));
            },
            function (err) {
                FOSSBilling.message(err?.message || "Could not load pricing");
            }
        );
    }

    function setTransferPricing(tld) {
        API.guest.post(
            'servicedomain/pricing',
            { tld: tld },
            function (result) {

                const price = bb.currency(
                    result.price_transfer,
                    {{ currency.conversion_rate }},
                    "{{ currency.code }}"
                );

                const transferPriceEl = document.getElementById('transfer-price');
                if (transferPriceEl) {
                    transferPriceEl.textContent = price;
                    fadeIn(transferPriceEl, '');
                }

                const nextBtnWrap = document.getElementById('config-next-domain2');
                if (nextBtnWrap) {
                    nextBtnWrap.style.display = '';
                }

                const nextBtn = nextBtnWrap ? nextBtnWrap.querySelector('button[type="submit"]') : null;
                if (nextBtn) {
                    nextBtn.disabled = false;
                }
            },
            function (err) {
                FOSSBilling.message(err?.message || "Could not load pricing");
            }
        );
    }
});
</script>
